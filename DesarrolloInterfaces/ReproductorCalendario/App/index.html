<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor de Audio con Calendario</title>
    
    <style>
        /* --- Diseño Minimalista: Variables de Color --- */
        :root {
            --primary-color: #007AFF; /* Azul iOS */
            --accent-color: #34C759; /* Verde iOS */
            --danger-color: #FF3B30; /* Rojo iOS */
            --background-color: #F2F2F7;
            --container-background: #FFFFFF;
            --text-color: #000000;
            --secondary-text-color: #8A8A8E; /* Gris secundario iOS */
            --border-color: #E5E5EA;
            --button-background-color: #EFEFF4;
        }

        body.dark-theme {
            --primary-color: #0A84FF;
            --accent-color: #30D158;
            --danger-color: #FF453A;
            --background-color: #000000;
            --container-background: #1C1C1E;
            --text-color: #FFFFFF;
            --secondary-text-color: #8D8D93;
            --border-color: #38383A;
            --button-background-color: #2C2C2E;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            -webkit-font-smoothing: antialiased;
            -webkit-tap-highlight-color: transparent; /* Remove tap highlight on mobile */
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            transition: background-color 0.3s, color 0.3s;
            justify-content: center;
            align-items: center;
            padding: 1rem;
        }
        
        #app-wrapper {
            width: 100%;
            max-width: 900px;
            margin: 0 auto;
        }

        /* --- Barra de Navegación Superior --- */
        .top-nav {
            background-color: var(--container-background);
            color: var(--secondary-text-color);
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.8rem;
            border-bottom: 1px solid var(--border-color);
            width: 100%;
            transition: background-color 0.3s, color 0.3s, border-bottom 0.3s;
        }
        
        #location-info {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }
        
        .nav-item { display: flex; align-items: center; gap: 0.3rem; }
        .nav-item svg { stroke: var(--secondary-text-color); }

        /* --- Contenido Principal --- */
        .main-content {
            padding: 2rem 1rem;
            width: 100%;
        }
        
        .main-title {
            text-align: center;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 2rem;
            color: var(--text-color);
        }

        /* --- Pestañas --- */
        .tabs { display: flex; margin-bottom: 1.5rem; position: relative; }
        .tabs::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 1px; background-color: var(--border-color); z-index: 1; }
        .tab-link { flex-grow: 1; text-align: center; padding: 0.8rem 1rem; border: none; background: none; cursor: pointer; color: var(--secondary-text-color); font-size: 1rem; font-weight: 500; transition: color 0.3s; position: relative; z-index: 2; }
        .tab-link:hover { color: var(--primary-color); }
        .tab-link.active { color: var(--primary-color); }
        .tab-link.active::after { content: ''; position: absolute; bottom: -1px; left: 15%; right: 15%; height: 3px; background-color: var(--primary-color); border-radius: 3px; transition: all 0.3s ease; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Contenedores Generales --- */
        .content-box {
            background: var(--container-background);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
            transition: background-color 0.3s, border-color 0.3s;
            overflow: hidden;
        }
        
        /* --- Calendario --- */
        #month-year-display { cursor: pointer; user-select: none; }
        #month-year-display:hover { color: var(--primary-color); }
        .calendar-container { overflow-x: auto; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; min-width: 320px; }
        .calendar-header-nav { display: flex; flex-grow: 1; justify-content: flex-start; align-items: center; }
        .calendar-header h2 { font-weight: 600; color: var(--text-color); text-align: center; margin: 0 1rem; }
        .calendar-header button { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--primary-color); width: 44px; height: 44px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; flex-shrink: 0; }
        .calendar-header button:hover { background-color: var(--button-background-color); }
        
        .calendar-grid-wrapper { min-width: 320px; }
        .calendar-grid, .calendar-weekdays { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; }
        .calendar-weekdays div { font-weight: 500; text-align: center; color: var(--secondary-text-color); font-size: 0.8rem; }
        .calendar-day { display: flex; justify-content: center; align-items: center; flex-direction: column; aspect-ratio: 1 / 1; border-radius: 50%; transition: all 0.2s; font-size: 1rem; position: relative; cursor: pointer; }
        
        .day-with-icon-bg::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: var(--icon-bg-url); background-size: 60%; background-position: center; background-repeat: no-repeat; opacity: 0.2; z-index: 1; }
        .calendar-day.empty { pointer-events: none; opacity: 0.5; }
        .calendar-day.has-task::before { content: ''; width: 5px; height: 5px; background-color: var(--primary-color); border-radius: 50%; position: absolute; bottom: 8px; left: calc(50% - 6px); }
        .calendar-day.has-audio::after { content: ''; width: 5px; height: 5px; background-color: var(--accent-color); border-radius: 50%; position: absolute; bottom: 8px; left: calc(50% + 1px); }
        .day-number { width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 50%; transition: background-color 0.2s, color 0.2s; position: relative; z-index: 2; }
        .calendar-day:hover .day-number { background-color: var(--button-background-color); }
        .calendar-day.today .day-number { background-color: var(--accent-color); color: white; font-weight: 700; }
        .day-with-icon-bg.today .day-number { background-color: transparent; color: var(--accent-color); }
        .day-action-btn { background: none; border: none; color: var(--secondary-text-color); width: 22px; height: 22px; font-size: 1.2rem; line-height: 22px; text-align: center; cursor: pointer; margin-top: 2px; transition: all 0.2s; opacity: 0; z-index: 5; }
        .calendar-day:hover .day-action-btn { opacity: 1; }
        .day-action-btn:hover { color: var(--primary-color); transform: scale(1.2); }
        
        #year-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; }
        .year-item { padding: 0.75rem 0.5rem; text-align: center; border-radius: 8px; cursor: pointer; transition: background-color 0.2s; }
        .year-item:hover { background-color: var(--button-background-color); }
        .year-item.selected { background-color: var(--primary-color) !important; color: white; font-weight: bold; }
        .year-item.current { background-color: var(--accent-color); color: white; }

        /* --- Pestaña de Tareas --- */
        .task-date-group { margin-bottom: 1.5rem; }
        .task-date-group h3 { font-weight: 600; color: var(--text-color); border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .task-item { display: flex; flex-direction: column; padding: 0.8rem 0; border-bottom: 1px solid var(--border-color); }
        .task-item:last-child { border-bottom: none; }
        .task-item-main { display: flex; justify-content: space-between; align-items: center; }
        .task-item-content { display: flex; align-items: center; gap: 0.8rem; flex-grow: 1; }
        .task-item input[type="checkbox"] { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary-color); }
        .task-item .task-title { transition: color 0.3s; }
        .task-item .task-title.completed { text-decoration: line-through; color: var(--secondary-text-color); }
        .task-item .task-actions { display: flex; gap: 0.5rem; }
        .task-item .note-btn, .task-item .delete-btn { background: none; border: none; cursor: pointer; padding: 0.3rem; }
        .task-item .note-btn svg { width: 18px; height: 18px; fill: var(--secondary-text-color); }
        .task-item .delete-btn { color: var(--danger-color); font-size: 1.5rem; }
        .task-notes { display: none; margin-top: 0.8rem; }
        .task-notes textarea { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--button-background-color); color: var(--text-color); font-size: 0.9rem; resize: vertical; min-height: 60px; }

        /* --- Pestaña de Configuración (Nuevo) --- */
        .settings-card { background-color: var(--button-background-color); padding: 1.5rem; border-radius: 12px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .settings-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .dark-theme .settings-card:hover { box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .settings-card h3 { font-weight: 600; font-size: 1.1rem; margin-bottom: 0.5rem; }
        .settings-card p { font-size: 0.9rem; color: var(--secondary-text-color); }
        .color-picker-item { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
        .color-picker-item input[type="color"] { -webkit-appearance: none; -moz-appearance: none; appearance: none; width: 44px; height: 44px; background-color: transparent; border: none; cursor: pointer; }
        .color-picker-item input[type="color"]::-webkit-color-swatch { border-radius: 8px; border: 1px solid var(--border-color); }
        .library-table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
        .library-table th, .library-table td { text-align: left; padding: 0.8rem; border-bottom: 1px solid var(--border-color); }
        .library-table th { font-weight: 600; font-size: 0.9rem; }
        .library-table td { font-size: 0.9rem; color: var(--secondary-text-color); }
        .library-table .sound-name { color: var(--text-color); font-weight: 500; }

        /* --- Reproductor de Audio UI --- */
        .player-container { display: flex; flex-direction: column; align-items: center; gap: 1.5rem; }
        #visualizer-canvas { width: 100%; max-width: 400px; height: 150px; border-radius: 12px; }
        .track-info { text-align: center; }
        #player-track-title { font-size: 1.2rem; font-weight: 600; }
        .progress-container { width: 100%; max-width: 400px; display: flex; flex-direction: column; gap: 0.5rem; }
        .time-display { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--secondary-text-color); font-family: 'SF Mono', 'Courier New', monospace; }
        .player-controls { display: flex; align-items: center; gap: 1.5rem; }
        .player-controls button { background: none; border: none; cursor: pointer; color: var(--text-color); display: flex; align-items: center; justify-content: center; }
        .player-controls button svg { fill: var(--text-color); width: 24px; height: 24px; }
        .player-controls button.active svg { fill: var(--primary-color); }
        .player-controls button:disabled { cursor: not-allowed; }
        .player-controls button:disabled svg { opacity: 0.5; }
        #player-play-pause-btn { background-color: var(--primary-color); width: 60px; height: 60px; border-radius: 50%; }
        #player-play-pause-btn svg { fill: white; width: 30px; height: 30px; }
        .track-card { padding: 0.8rem; border-radius: 8px; border: 1px solid var(--border-color); margin-bottom: 0.5rem; cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .track-card:hover { transform: scale(1.02); box-shadow: 0 4px 10px rgba(0,0,0,0.05); }
        .dark-theme .track-card:hover { box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .track-card.playing { border-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        #full-playlist-container { max-height: 400px; overflow-y: auto; }

        /* --- Ventana Emergente (Modal) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: none; justify-content: center; align-items: center; z-index: 2000; backdrop-filter: blur(5px); }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--container-background); padding: 1.5rem; border-radius: 12px; width: 90%; max-width: 500px; animation: slideIn 0.3s ease-out; max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; margin-bottom: 1rem; flex-shrink: 0; }
        #modal-title { font-weight: 600; font-size: 1.2rem; }
        #modal-close-btn { background: none; border: none; font-size: 2rem; cursor: pointer; color: var(--secondary-text-color); line-height: 1; }
        .modal-body { line-height: 1.6; overflow-y: auto; }
        .modal-body input, .modal-body select { width: 100%; padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background-color: var(--button-background-color); color: var(--text-color); font-size: 1rem; }
        .icon-selector { display: flex; justify-content: space-around; margin-top: 1rem; }
        .icon-selector button { background: none; border: 2px solid transparent; border-radius: 50%; width: 40px; height: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .icon-selector button.selected { border-color: var(--primary-color); }
        .icon-selector button svg { width: 24px; height: 24px; fill: var(--secondary-text-color); }
        .modal-actions { margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color); display: flex; gap: 10px; flex-shrink: 0; }
        .modal-actions button { flex-grow: 1; padding: 0.8rem; border: none; border-radius: 8px; font-size: 1rem; font-weight: 500; cursor: pointer; transition: opacity 0.2s; }
        .modal-actions button:hover { opacity: 0.8; }
        #modal-save-btn { background-color: var(--accent-color); color: white; }
        #modal-remove-btn { background-color: var(--danger-color); color: white; }

        /* --- ESTILOS RESPONSIVOS PARA MÓVILES --- */
        @media (max-width: 768px) {
            body { padding: 0; }
            #app-wrapper { border-radius: 0; }
            .main-content { padding: 1rem; }
            .main-title { font-size: 1.5rem; }
            .player-container { gap: 1rem; }
        }
        @media (max-width: 480px) {
            .calendar-day { font-size: 0.9rem; }
            .player-controls { gap: 1rem; }
            .tab-link { font-size: 0.9rem; padding: 0.8rem 0.5rem; }
        }
    </style>
</head>
<body>

<div id="app-wrapper">
    <nav class="top-nav">
        <div id="location-info">Cargando ubicación y zona horaria...</div>
    </nav>

    <main class="main-content">
        <h1 class="main-title">ProMinimal Calendar of Sounds</h1>
        <div class="tabs">
            <button class="tab-link active" data-tab="calendar-tab">Calendario</button>
            <button class="tab-link" data-tab="player-tab">Reproductor</button>
            <button class="tab-link" data-tab="tasks-tab">Tareas</button>
            <button class="tab-link" data-tab="settings-tab">Configuración</button>
        </div>
        
        <div id="calendar-tab" class="tab-content active">
            <div id="calendar-container" class="content-box calendar-container">
                <div class="calendar-header">
                    <div class="calendar-header-nav">
                        <button id="prev-month-btn" aria-label="Mes anterior">&lt;</button>
                        <h2 id="month-year-display"></h2>
                        <button id="next-month-btn" aria-label="Mes siguiente">&gt;</button>
                    </div>
                </div>
                <div class="calendar-grid-wrapper">
                    <div class="calendar-weekdays">
                        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
                    </div>
                    <div id="calendar-grid" class="calendar-grid"></div>
                </div>
                <div id="year-selector-wrapper" style="display: none;">
                    <div id="year-grid"></div>
                </div>
            </div>
        </div>

        <div id="player-tab" class="tab-content">
            <div class="content-box player-container">
               <canvas id="visualizer-canvas"></canvas>
                <div class="track-info">
                    <p id="player-track-title">Ningún sonido seleccionado</p>
                </div>
                <div class="progress-container">
                    <input type="range" id="player-progress-bar" value="0" step="1" style="width: 100%;">
                    <div class="time-display">
                        <span id="player-current-time">0:00</span>
                        <span id="player-total-time">0:00</span>
                    </div>
                </div>
                <div class="player-controls">
                    <button id="player-shuffle-btn"></button>
                    <button id="player-prev-btn"></button>
                    <button id="player-play-pause-btn"></button>
                    <button id="player-next-btn"></button>
                    <button id="player-repeat-btn"></button>
                </div>
            </div>
            <div id="playlist-container" class="content-box">
                <h2>Pistas Largas</h2>
                <div id="full-playlist-items"></div>
            </div>
        </div>
        
        <div id="tasks-tab" class="tab-content">
            <div id="tasks-list-container" class="content-box">
                <!-- Las tareas por día se renderizarán aquí -->
            </div>
        </div>

        <div id="settings-tab" class="tab-content">
            <div class="content-box" style="padding: 0; background-color: transparent; border: none;">
                <div style="display: grid; gap: 1rem;">
                    <div id="theme-settings-card" class="settings-card">
                        <h3>Tema de la Aplicación</h3>
                        <p>Personaliza los colores de la interfaz.</p>
                    </div>
                    <div id="library-settings-card" class="settings-card">
                        <h3>Biblioteca de Sonidos</h3>
                        <p>Gestiona tus archivos de audio.</p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</div>

    <!-- HTML de la Ventana Emergente (Modal) -->
    <div id="day-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title"></h3>
                <button id="modal-close-btn" aria-label="Cerrar">&times;</button>
            </div>
            <div id="modal-body" class="modal-body"></div>
            <div id="modal-actions" class="modal-actions"></div>
        </div>
    </div>

    <audio id="audio-element" crossorigin="anonymous"></audio>
    <input type="file" id="sound-library-input" multiple accept="audio/*" style="display: none;">

    <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- ICONOS SVG ---
        const ICONS = {
            location: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>`,
            clock: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`,
            play: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>`,
            pause: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"></path></svg>`,
            prev: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M6 6h2v12H6zm3.5 6 8.5 6V6z"></path></svg>`,
            next: `<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM8 18l8.5-6L8 6z"></path></svg>`,
            party: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,2L5.5,10H18.5L12,2M12,11A2,2 0 0,0 10,13A2,2 0 0,0 12,15A2,2 0 0,0 14,13A2,2 0 0,0 12,11M12,16C10.9,16 10,16.9 10,18V22H14V18C14,16.9 13.1,16 12,16Z"/></svg>`, 
            meeting: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M14.5,18H11.5V13H9.5V18H6.5V13H4.5V18H2V12A2,2 0 0,1 4,10H17A2,2 0 0,1 19,12V18H16.5V13H14.5V18M17,9H4A1,1 0 0,0 3,10V11H18V10A1,1 0 0,0 17,9M12,7A3,3 0 0,1 9,4A3,3 0 0,1 12,1A3,3 0 0,1 15,4A3,3 0 0,1 12,7Z"/></svg>`,
            event: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12,17.27L18.18,21L16.54,13.97L22,9.24L14.81,8.62L12,2L9.19,8.62L2,9.24L7.45,13.97L5.82,21L12,17.27Z" /></svg>`,
            game: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18.5,2H5.5A2.5,2.5 0 0,0 3,4.5V19.5A2.5,2.5 0 0,0 5.5,22H18.5A2.5,2.5 0 0,0 21,19.5V4.5A2.5,2.5 0 0,0 18.5,2M12,19.36C10.15,19.36 8.64,17.85 8.64,16H15.36C15.36,17.85 13.85,19.36 12,19.36M18,13H6V11H18V13Z"/></svg>`,
            shuffle: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10.59,9.17L5.41,4L4,5.41L9.17,10.59L10.59,9.17M14.83,13.41L13.41,14.83L18.59,20L20,18.59L14.83,13.41M14.83,9.17L9.17,3.5L4,8.67V4H2V10H8L3,15L4.41,16.41L10.59,10.24L11.76,11.41L10.21,12.96L11.62,14.38L13.41,12.59L14.83,9.17Z" /></svg>`,
            repeat: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z" /></svg>`,
            repeatOne: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13,15V9H12L10,10V11H11.5V15M17,17H7V14L3,18L7,22V19H19V13H17M7,7H17V10L21,6L17,2V5H5V11H7V7Z" /></svg>`,
            note: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71,7.04C21.1,6.65 21.1,6 20.71,5.63L18.37,3.29C18,2.9 17.35,2.9 16.96,3.29L15.13,5.12L18.88,8.87M3,17.25V21H6.75L17.81,9.94L14.06,6.19L3,17.25Z" /></svg>`
        };

        // --- ESTADO Y DATOS ---
        let dayDataMap = {}; 
        let audioMap = {};
        let soundLibrary = [];
        let currentDate = new Date();
        let currentlyEditingDate = null;
        let currentTrackIndex = -1;
        let isVisualizerSetup = false;
        let audioContext, analyser, sourceNode, frequencyData;
        let isShuffling = false;
        let repeatMode = 'none';
        let calendarViewMode = 'days';
        let yearSelectorBaseYear = new Date().getFullYear();
        let dynamicThemeEnabled = false;
        let currentDynamicHue = 210; // Blue start

        // --- ELEMENTOS DEL DOM ---
        const tabLinks = document.querySelectorAll('.tab-link');
        const tabContents = document.querySelectorAll('.tab-content');
        const locationInfo = document.getElementById('location-info');
        const monthYearDisplay = document.getElementById('month-year-display');
        const calendarGrid = document.getElementById('calendar-grid');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const modalOverlay = document.getElementById('day-modal-overlay');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalActions = document.getElementById('modal-actions');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const audioElement = document.getElementById('audio-element');
        const playerTrackTitle = document.getElementById('player-track-title');
        const playerProgressBar = document.getElementById('player-progress-bar');
        const playerCurrentTime = document.getElementById('player-current-time');
        const playerTotalTime = document.getElementById('player-total-time');
        const playerPrevBtn = document.getElementById('player-prev-btn');
        const playerPlayPauseBtn = document.getElementById('player-play-pause-btn');
        const playerNextBtn = document.getElementById('player-next-btn');
        const playerShuffleBtn = document.getElementById('player-shuffle-btn');
        const playerRepeatBtn = document.getElementById('player-repeat-btn');
        const visualizerCanvas = document.getElementById('visualizer-canvas');
        const visualizerCtx = visualizerCanvas.getContext('2d');
        const soundLibraryInput = document.getElementById('sound-library-input');
        const fullPlaylistItems = document.getElementById('full-playlist-items');
        const tasksListContainer = document.getElementById('tasks-list-container');
        const calendarGridWrapper = document.querySelector('.calendar-grid-wrapper');
        const yearSelectorWrapper = document.getElementById('year-selector-wrapper');
        const yearGrid = document.getElementById('year-grid');
        const themeSettingsCard = document.getElementById('theme-settings-card');
        const librarySettingsCard = document.getElementById('library-settings-card');
        
        // --- INICIALIZACIÓN ---
        async function init() {
            await initDB();
            await loadAppData();
            applyCustomTheme();
            
            displayNavbarInfo();
            setupTabs();
            setupPlayer();
            renderCalendar();
            renderTasks();
            renderFullPlaylist();
            
            prevMonthBtn.addEventListener('click', handlePrevClick);
            nextMonthBtn.addEventListener('click', handleNextClick);
            monthYearDisplay.addEventListener('click', toggleCalendarViewMode);
            themeSettingsCard.addEventListener('click', openThemeModal);
            librarySettingsCard.addEventListener('click', openLibraryModal);
            modalCloseBtn.addEventListener('click', closeDayModal);
            modalOverlay.addEventListener('click', (e) => { if (e.target === modalOverlay) closeDayModal(); });
            soundLibraryInput.addEventListener('change', handleFileSelection);

            playerPlayPauseBtn.addEventListener('click', togglePlayPause);
            playerNextBtn.addEventListener('click', playNextTrack);
            playerPrevBtn.addEventListener('click', playPrevTrack);
            playerShuffleBtn.addEventListener('click', toggleShuffle);
            playerRepeatBtn.addEventListener('click', cycleRepeatMode);
            audioElement.addEventListener('timeupdate', updatePlayerProgress);
            audioElement.addEventListener('loadedmetadata', updatePlayerProgress);
            audioElement.addEventListener('ended', handleTrackEnd);
            playerProgressBar.addEventListener('input', setAudioPosition);
            
            tasksListContainer.addEventListener('change', handleTaskCheck);
            tasksListContainer.addEventListener('click', (e) => {
                if (e.target.closest('.delete-btn')) handleTaskDelete(e);
                if (e.target.closest('.note-btn')) toggleTaskNotes(e);
            });
            tasksListContainer.addEventListener('blur', (e) => {
                 if (e.target.tagName === 'TEXTAREA') saveTaskNote(e);
            }, true);
        }
        
        // --- PERSISTENCIA Y BASE DE DATOS ---
        let db;
        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('SoundLibraryDB', 1);
                request.onupgradeneeded = e => e.target.result.createObjectStore('sounds', { keyPath: 'name' });
                request.onsuccess = e => { db = e.target.result; resolve(); };
                request.onerror = e => { console.error("IndexedDB error:", e.target.errorCode); reject(); };
            });
        }

        const saveDataToStorage = () => {
            try {
                localStorage.setItem('audioMap', JSON.stringify(audioMap));
                localStorage.setItem('dayDataMap', JSON.stringify(dayDataMap));
                localStorage.setItem('dynamic_theme_enabled', dynamicThemeEnabled);
            } catch (e) {
                console.error("LocalStorage error:", e);
            }
        };

        function loadAppData() {
            return new Promise(resolve => {
                dynamicThemeEnabled = localStorage.getItem('dynamic_theme_enabled') === 'true';
                audioMap = JSON.parse(localStorage.getItem('audioMap')) || {};
                dayDataMap = JSON.parse(localStorage.getItem('dayDataMap')) || {};
                
                const transaction = db.transaction(['sounds'], 'readonly');
                const store = transaction.objectStore('sounds');
                const request = store.getAll();
                request.onsuccess = e => { soundLibrary = e.target.result; resolve(); };
                request.onerror = () => resolve(); // Resolve even if DB fails
            });
        }
        
        // --- BIBLIOTECA DE SONIDOS ---
        function handleLibraryFileSelect() {
             soundLibraryInput.click();
        }

        async function handleFileSelection(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;

            const soundRecords = await Promise.all(Array.from(files).map(async file => {
                const duration = await getAudioDuration(URL.createObjectURL(file));
                return { name: file.name, file: file, duration: duration };
            }));

            const transaction = db.transaction(['sounds'], 'readwrite');
            const store = transaction.objectStore('sounds');
            soundRecords.forEach(record => store.put(record));

            transaction.oncomplete = () => {
                soundRecords.forEach(record => {
                    const existingIndex = soundLibrary.findIndex(s => s.name === record.name);
                    if (existingIndex > -1) soundLibrary[existingIndex] = record;
                    else soundLibrary.push(record);
                });
                renderLibraryModalContent();
                renderFullPlaylist();
            };
            transaction.onerror = (e) => console.error("Error al escribir en IndexedDB:", e.target.error);
            event.target.value = '';
        }
        
        const getAudioDuration = src => new Promise(resolve => {
            const audio = new Audio();
            audio.onloadedmetadata = () => { URL.revokeObjectURL(src); resolve(audio.duration); };
            audio.onerror = () => { URL.revokeObjectURL(src); resolve(Infinity); };
            audio.src = src;
        });
        
        // --- REPRODUCTOR (Funciones omitidas por brevedad) ---
        const setupPlayer = () => {
            playerPlayPauseBtn.innerHTML = ICONS.play;
            playerPrevBtn.innerHTML = ICONS.prev;
            playerNextBtn.innerHTML = ICONS.next;
            playerShuffleBtn.innerHTML = ICONS.shuffle;
            playerRepeatBtn.innerHTML = ICONS.repeat;
        };
        const getLongPlayableTracks = () => soundLibrary.filter(s => s.duration >= 11);


        // --- UI GENERAL Y PESTAÑAS ---
        const setupTabs = () => {
             tabLinks.forEach(tab => {
                tab.addEventListener('click', (e) => {
                    e.preventDefault();
                    switchToTab(tab.dataset.tab);
                });
            });
        };

        function switchToTab(tabId) {
            tabLinks.forEach(link => link.classList.toggle('active', link.dataset.tab === tabId));
            tabContents.forEach(content => content.classList.toggle('active', content.id === tabId));
            if (tabId === 'tasks-tab') {
                renderTasks();
            }
        }

        // --- CALENDARIO (Lógica de navegación y renderizado) ---
        function handlePrevClick() {
            if (calendarViewMode === 'days') {
                currentDate.setMonth(currentDate.getMonth() - 1);
                renderCalendar();
            } else {
                yearSelectorBaseYear -= 12;
                renderYearSelector();
            }
        }
        function handleNextClick() {
            if (calendarViewMode === 'days') {
                currentDate.setMonth(currentDate.getMonth() + 1);
                renderCalendar();
            } else {
                yearSelectorBaseYear += 12;
                renderYearSelector();
            }
        }
        function toggleCalendarViewMode() {
            if (calendarViewMode === 'days') {
                calendarViewMode = 'years';
                yearSelectorBaseYear = currentDate.getFullYear();
                calendarGridWrapper.style.display = 'none';
                yearSelectorWrapper.style.display = 'block';
                renderYearSelector();
            } else {
                calendarViewMode = 'days';
                calendarGridWrapper.style.display = 'block';
                yearSelectorWrapper.style.display = 'none';
                renderCalendar();
            }
        }
        function renderYearSelector() {
            const startYear = Math.floor(yearSelectorBaseYear / 12) * 12;
            monthYearDisplay.textContent = `${startYear} - ${startYear + 11}`;
            yearGrid.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const year = startYear + i;
                const yearItem = document.createElement('div');
                yearItem.className = 'year-item';
                yearItem.textContent = year;
                if (year === currentDate.getFullYear()) yearItem.classList.add('selected');
                if (year === new Date().getFullYear()) yearItem.classList.add('current');
                yearItem.addEventListener('click', () => {
                    currentDate.setFullYear(year);
                    toggleCalendarViewMode();
                });
                yearGrid.appendChild(yearItem);
            }
        }
        function renderCalendar() {
            calendarViewMode = 'days';
            calendarGridWrapper.style.display = 'block';
            yearSelectorWrapper.style.display = 'none';
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            monthYearDisplay.textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
            calendarGrid.innerHTML = '';
            const firstDayOfMonth = new Date(year, month, 1);
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            let startDayIndex = (firstDayOfMonth.getDay() === 0) ? 6 : firstDayOfMonth.getDay() - 1;
            const today = new Date();
            for (let i = 0; i < startDayIndex; i++) calendarGrid.insertAdjacentHTML('beforeend', '<div class="calendar-day empty"></div>');
            for (let day = 1; day <= daysInMonth; day++) {
                const dayCell = document.createElement('div');
                dayCell.className = 'calendar-day';
                const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayCell.innerHTML = `<span class="day-number">${day}</span><button class="day-action-btn">+</button>`;
                if (new Date(year, month, day).toDateString() === today.toDateString()) dayCell.classList.add('today');
                if (audioMap[dateString]) dayCell.classList.add('has-audio');
                if (dayDataMap[dateString]?.tasks?.length > 0) dayCell.classList.add('has-task');
                if (dayDataMap[dateString]?.icon) {
                    dayCell.style.setProperty('--icon-bg-url', `url('data:image/svg+xml;utf8,${encodeURIComponent(ICONS[dayDataMap[dateString].icon])}')`);
                    dayCell.classList.add('day-with-icon-bg');
                }
                dayCell.addEventListener('click', () => playAudioForDate(dateString));
                dayCell.querySelector('.day-action-btn').addEventListener('click', (e) => { e.stopPropagation(); openDayModal(dateString); });
                calendarGrid.appendChild(dayCell);
            }
        }
        
        // --- LÓGICA DE TAREAS ---
        function renderTasks() {
            tasksListContainer.innerHTML = '';
            const allTasksDates = Object.keys(dayDataMap).filter(date => dayDataMap[date].tasks && dayDataMap[date].tasks.length > 0);
            allTasksDates.sort((a, b) => new Date(a) - new Date(b));
            if (allTasksDates.length === 0) {
                tasksListContainer.innerHTML = `<p style="color: var(--secondary-text-color);">No hay tareas programadas.</p>`;
                return;
            }
            allTasksDates.forEach(dateString => {
                const dateGroup = document.createElement('div');
                dateGroup.className = 'task-date-group';
                const formattedDate = new Date(dateString + 'T12:00:00').toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                dateGroup.innerHTML = `<h3>${formattedDate}</h3>`;
                const ul = document.createElement('ul');
                dayDataMap[dateString].tasks.forEach(task => {
                    const li = document.createElement('li');
                    li.className = 'task-item';
                    li.innerHTML = `
                        <div class="task-item-main">
                            <div class="task-item-content">
                                <input type="checkbox" data-date="${dateString}" data-id="${task.id}" ${task.completed ? 'checked' : ''}>
                                <span class="task-title ${task.completed ? 'completed' : ''}">${task.title}</span>
                            </div>
                            <div class="task-actions">
                                <button class="note-btn" data-id="${task.id}">${ICONS.note}</button>
                                <button class="delete-btn" data-id="${task.id}">&times;</button>
                            </div>
                        </div>
                        <div class="task-notes">
                            <textarea data-id="${task.id}" placeholder="Añadir notas...">${task.notes || ''}</textarea>
                        </div>`;
                    ul.appendChild(li);
                });
                dateGroup.appendChild(ul);
                tasksListContainer.appendChild(dateGroup);
            });
        }
        function handleTaskCheck(e) {
            if (e.target.type !== 'checkbox') return;
            const { id, date } = e.target.dataset;
            const task = dayDataMap[date]?.tasks.find(t => t.id == id);
            if (task) {
                task.completed = e.target.checked;
                saveDataToStorage();
                e.target.nextElementSibling.classList.toggle('completed', task.completed);
            }
        }
        function handleTaskDelete(e) {
            const button = e.target.closest('.delete-btn');
            if (!button) return;
            const { id } = button.dataset;
            let taskDate;
            for (const dateKey in dayDataMap) {
                if (dayDataMap[dateKey].tasks && dayDataMap[dateKey].tasks.find(t => t.id == id)) {
                    taskDate = dateKey;
                    break;
                }
            }
            if (taskDate && dayDataMap[taskDate]?.tasks) {
                dayDataMap[taskDate].tasks = dayDataMap[taskDate].tasks.filter(t => t.id != id);
                saveDataToStorage();
                renderTasks();
                renderCalendar();
            }
        }
        function toggleTaskNotes(e) {
            const button = e.target.closest('.note-btn');
            if (!button) return;
            const notesDiv = button.closest('.task-item').querySelector('.task-notes');
            if (notesDiv) {
                notesDiv.style.display = notesDiv.style.display === 'block' ? 'none' : 'block';
                if (notesDiv.style.display === 'block') {
                    notesDiv.querySelector('textarea').focus();
                }
            }
        }
        function saveTaskNote(e) {
            const textarea = e.target;
            const { id } = textarea.dataset;
            let taskDate;
            for (const dateKey in dayDataMap) {
                if (dayDataMap[dateKey].tasks && dayDataMap[dateKey].tasks.find(t => t.id == id)) {
                    taskDate = dateKey;
                    break;
                }
            }
            if (taskDate) {
                 const task = dayDataMap[taskDate].tasks.find(t => t.id == id);
                 if (task) {
                    task.notes = textarea.value;
                    saveDataToStorage();
                }
            }
        }

        // --- FUNCIONES DEL MODAL ---
        const displayNavbarInfo = () => { /* ... idéntica ... */ };
        function openDayModal(dateString) { /* ... idéntica ... */ }
        function renderModalTaskList(dateString) { /* ... idéntica ... */ }
        function closeDayModal() { modalOverlay.classList.remove('visible'); currentlyEditingDate = null; renderTasks(); }
        function saveDayData() { /* ... idéntica ... */ }
        function removeDayData() { /* ... idéntica ... */ }
        
        function playAudioForDate(dateString) {
            const specificSound = audioMap[dateString];
            if (!specificSound) return;
            const sound = soundLibrary.find(s => s.name === specificSound.title);
            if (sound && sound.duration < 11) playTrack(soundLibrary.indexOf(sound));
        }

        // --- MODALES Y LÓGICA DE TEMA (MODIFICADO) ---
        function openThemeModal() {
            modalTitle.textContent = "Personalizar Tema";
            
            modalBody.innerHTML = `
                <div class="color-picker-item">
                    <label for="master-hue-picker">Color Principal</label>
                    <input type="color" id="master-hue-picker" value="${localStorage.getItem('custom_base_color') || '#007AFF'}">
                </div>
                <div class="setting-item" style="padding: 1rem 0; border: none; justify-content: space-between; display: flex;">
                    <label for="dynamic-theme-toggle">Color dinámico con música</label>
                    <input type="checkbox" id="dynamic-theme-toggle" ${dynamicThemeEnabled ? 'checked' : ''} style="width: 20px; height: 20px;">
                </div>
            `;

            modalActions.innerHTML = `<button id="reset-light-theme">Restaurar Claro</button><button id="reset-dark-theme">Restaurar Oscuro</button>`;
            
            document.getElementById('master-hue-picker').addEventListener('input', (e) => {
                const baseColor = e.target.value;
                generateAndApplyTheme(baseColor);
                localStorage.setItem('custom_base_color', baseColor);
                localStorage.setItem('dynamic_theme_enabled', 'false');
                document.getElementById('dynamic-theme-toggle').checked = false;
                dynamicThemeEnabled = false;
            });

            document.getElementById('dynamic-theme-toggle').addEventListener('change', (e) => {
                dynamicThemeEnabled = e.target.checked;
                saveDataToStorage();
                if(!dynamicThemeEnabled) applyCustomTheme();
            });

            document.getElementById('reset-light-theme').addEventListener('click', () => setTheme('light', true));
            document.getElementById('reset-dark-theme').addEventListener('click', () => setTheme('dark', true));

            modalOverlay.classList.add('visible');
        }

        function openLibraryModal() {
            modalTitle.textContent = "Biblioteca de Sonidos";
            renderLibraryModalContent();
            modalActions.innerHTML = `<button id="add-sounds-btn">Añadir Archivos</button>`;
            document.getElementById('add-sounds-btn').addEventListener('click', handleLibraryFileSelect);
            modalOverlay.classList.add('visible');
        }
        
        function renderLibraryModalContent() {
             modalBody.innerHTML = `
                <div style="max-height: 400px; overflow-y: auto;">
                    <table class="library-table">
                        <thead><tr><th>Nombre</th><th>Duración</th><th>Tipo</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>`;
            const tbody = modalBody.querySelector('tbody');
            if (soundLibrary.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align:center; color: var(--secondary-text-color);">Tu biblioteca está vacía.</td></tr>';
            } else {
                tbody.innerHTML = soundLibrary.map(s => `
                    <tr>
                        <td class="sound-name">${s.name}</td>
                        <td>${formatTime(s.duration)}</td>
                        <td>${s.duration < 11 ? 'Calendario' : 'Reproductor'}</td>
                    </tr>`).join('');
            }
        }
        
        const DEFAULT_THEMES = {
            light: {'--primary-color':'#007AFF','--accent-color':'#34C759','--danger-color':'#FF3B30','--background-color':'#F2F2F7','--container-background':'#FFFFFF','--text-color':'#000000','--secondary-text-color':'#8A8A8E','--border-color':'#E5E5EA','--button-background-color':'#EFEFF4'},
            dark: {'--primary-color':'#0A84FF','--accent-color':'#30D158','--danger-color':'#FF453A','--background-color':'#000000','--container-background':'#1C1C1E','--text-color':'#FFFFFF','--secondary-text-color':'#8D8D93','--border-color':'#38383A','--button-background-color':'#2C2C2E'}
        };

        const setTheme = (themeName, forceReset = false) => {
            document.body.classList.toggle('dark-theme', themeName === 'dark');
            localStorage.setItem('theme_mode', themeName);

            if (forceReset) {
                localStorage.removeItem('custom_base_color');
                localStorage.setItem('dynamic_theme_enabled', 'false');
                dynamicThemeEnabled = false;
                applyCustomTheme();
                closeDayModal();
            }
        };
        
        function applyCustomTheme() {
            const themeMode = localStorage.getItem('theme_mode') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            document.body.classList.toggle('dark-theme', themeMode === 'dark');

            const defaults = DEFAULT_THEMES[themeMode];
            for (const [key, value] of Object.entries(defaults)) {
                document.documentElement.style.setProperty(key, value);
            }
            
            const baseColor = localStorage.getItem('custom_base_color');
            if (baseColor && !dynamicThemeEnabled) {
                generateAndApplyTheme(baseColor);
            }
        }

        function hexToHSL(H) {
            let r=0,g=0,b=0;if(H.length==4){r="0x"+H[1]+H[1];g="0x"+H[2]+H[2];b="0x"+H[3]+H[3]}else if(H.length==7){r="0x"+H[1]+H[2];g="0x"+H[3]+H[4];b="0x"+H[5]+H[6]}r/=255;g/=255;b/=255;let cmin=Math.min(r,g,b),cmax=Math.max(r,g,b),delta=cmax-cmin,h=0,s=0,l=0;if(delta==0)h=0;else if(cmax==r)h=((g-b)/delta)%6;else if(cmax==g)h=(b-r)/delta+2;else h=(r-g)/delta+4;h=Math.round(h*60);if(h<0)h+=360;l=(cmax+cmin)/2;s=delta==0?0:delta/(1-Math.abs(2*l-1));s=+(s*100).toFixed(1);l=+(l*100).toFixed(1);return{h,s,l}
        }

        function generateAndApplyTheme(baseColorHex) {
            const { h, s, l } = hexToHSL(baseColorHex);
            const isDark = document.body.classList.contains('dark-theme');
            const theme = {
                '--primary-color': `hsl(${h}, ${Math.min(s, 80)}%, ${isDark ? 55 : 50}%)`,
                '--accent-color': `hsl(${(h + 120) % 360}, 70%, 55%)`,
                '--background-color': isDark ? `hsl(${h}, 10%, 10%)` : `hsl(${h}, 20%, 95%)`,
                '--container-background': isDark ? `hsl(${h}, 10%, 15%)` : `hsl(${h}, 20%, 100%)`,
                '--text-color': isDark ? `hsl(${h}, 15%, 85%)` : `hsl(${h}, 15%, 10%)`
            };
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
        }

        function generateAndApplyThemeFromHue(hue) {
            const isDark = document.body.classList.contains('dark-theme');
            const s = 80;
            const theme = {
                '--primary-color': `hsl(${hue}, ${s}%, ${isDark ? 55 : 50}%)`,
                '--accent-color': `hsl(${(hue + 120) % 360}, 70%, 55%)`,
                '--background-color': isDark ? `hsl(${hue}, 10%, 10%)` : `hsl(${hue}, 20%, 95%)`,
                '--container-background': isDark ? `hsl(${hue}, 10%, 15%)` : `hsl(${hue}, 20%, 100%)`,
                '--text-color': isDark ? `hsl(${hue}, 15%, 85%)` : `hsl(${hue}, 15%, 10%)`
            };
            for (const [key, value] of Object.entries(theme)) {
                document.documentElement.style.setProperty(key, value);
            }
        }

        // --- Funciones del reproductor y visualizador ---
        function togglePlayPause(){if(!audioElement.src||isNaN(audioElement.duration))return;audioElement.paused?(audioElement.play(),playerPlayPauseBtn.innerHTML=ICONS.pause):(audioElement.pause(),playerPlayPauseBtn.innerHTML=ICONS.play)}
        function playTrack(b,c=!1){const d=getLongPlayableTracks(),e=c?d:soundLibrary;if(b<0||b>=e.length)return;const f=e[b];currentTrackIndex=c?d.findIndex(a=>a.name===f.name):-1;isVisualizerSetup||setupAudioVisualizer();playerTrackTitle.textContent=f.name;if(audioElement.src.startsWith('blob:'))URL.revokeObjectURL(audioElement.src);audioElement.src=URL.createObjectURL(f.file);audioElement.play();playerPlayPauseBtn.innerHTML=ICONS.pause;playerPrevBtn.disabled=!c||currentTrackIndex<=0;playerNextBtn.disabled=!c||currentTrackIndex>=d.length-1;renderFullPlaylist();const g=Array.from(tabLinks).find(a=>a.dataset.tab==="player-tab");g&&switchToTab(g.dataset.tab)}
        function playNextTrack(){const a=getLongPlayableTracks();if(isShuffling){playRandomTrack();return}if(a.length===0||currentTrackIndex>=a.length-1)return;playTrack(currentTrackIndex+1,!0)}
        function playPrevTrack(){const a=getLongPlayableTracks();if(a.length===0||currentTrackIndex<=0)return;playTrack(currentTrackIndex-1,!0)}
        function playRandomTrack(){const a=getLongPlayableTracks();if(a.length<=1)return;let c;do{c=Math.floor(Math.random()*a.length)}while(c===currentTrackIndex);playTrack(c,!0)}
        function handleTrackEnd(){playerPlayPauseBtn.innerHTML=ICONS.play;const a=getLongPlayableTracks();repeatMode==="one"?playTrack(currentTrackIndex,!0):isShuffling?playRandomTrack(!0):repeatMode==="all"&&currentTrackIndex===a.length-1?playTrack(0,!0):playNextTrack()}
        function updatePlayerProgress(){if(isNaN(audioElement.duration))return;const{currentTime:a,duration:b}=audioElement;playerProgressBar.value=b>0?a/b*100:0;playerCurrentTime.textContent=formatTime(a);playerTotalTime.textContent=formatTime(b)}
        const formatTime=a=>isNaN(a)?"0:00":`${Math.floor(a/60)}:${String(Math.floor(a%60)).padStart(2,"0")}`;
        function setAudioPosition(){!isNaN(audioElement.duration)&&(audioElement.currentTime=playerProgressBar.value/100*audioElement.duration)}
        function toggleShuffle(){isShuffling=!isShuffling,playerShuffleBtn.classList.toggle("active",isShuffling)}
        function cycleRepeatMode(){"none"===repeatMode?(repeatMode="all",playerRepeatBtn.innerHTML=ICONS.repeat,playerRepeatBtn.classList.add("active")):"all"===repeatMode?(repeatMode="one",playerRepeatBtn.innerHTML=ICONS.repeatOne):(repeatMode="none",playerRepeatBtn.innerHTML=ICONS.repeat,playerRepeatBtn.classList.remove("active"))}
        function renderFullPlaylist(){fullPlaylistItems.innerHTML="";const a=getLongPlayableTracks();if(a.length===0){fullPlaylistItems.innerHTML='<p style="text-align: center; color: var(--secondary-text-color)">No hay pistas largas.</p>';return}a.forEach((b,c)=>{const d=document.createElement("div");d.className="track-card",c===currentTrackIndex&&d.classList.add("playing"),d.textContent=b.name,d.addEventListener("click",()=>playTrack(c,!0)),fullPlaylistItems.appendChild(d)})}
        function setupAudioVisualizer(){if(isVisualizerSetup)return;try{audioContext=new(window.AudioContext||window.webkitAudioContext),analyser=audioContext.createAnalyser(),sourceNode=audioContext.createMediaElementSource(audioElement),sourceNode.connect(analyser),analyser.connect(audioContext.destination),analyser.fftSize=256;const a=analyser.frequencyBinCount;frequencyData=new Uint8Array(a),isVisualizerSetup=!0,drawVisualizer()}catch(b){console.error("No se pudo inicializar el visualizador de audio.",b)}}
        function drawVisualizer() {
            requestAnimationFrame(drawVisualizer);
            if (!isVisualizerSetup || !analyser) return;

            analyser.getByteFrequencyData(frequencyData);

            // Tema dinámico basado en frecuencias
            if (dynamicThemeEnabled && !audioElement.paused) {
                const binCount = analyser.frequencyBinCount;
                const lowFreqAvg = frequencyData.slice(0, binCount / 8).reduce((a, b) => a + b, 0) / (binCount / 8);
                const midFreqAvg = frequencyData.slice(binCount / 8, binCount / 2).reduce((a, b) => a + b, 0) / (binCount / 2 - binCount / 8);
                const targetHue = lowFreqAvg / midFreqAvg > 1.2 ? 30 : 220;
                currentDynamicHue += (targetHue - currentDynamicHue) * 0.01;
                generateAndApplyThemeFromHue(currentDynamicHue);
            }

            // Limpiar canvas si está pausado
            if (audioElement.paused) {
                visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);
                return;
            }

            // Limpiar canvas para nueva animación
            visualizerCtx.clearRect(0, 0, visualizerCanvas.width, visualizerCanvas.height);

            // NUEVA VISUALIZACIÓN: ONDAS/WAVEFORM en lugar de barras
            const width = visualizerCanvas.width;
            const height = visualizerCanvas.height;
            const centerY = height / 2;

            // Configurar el estilo de línea
            visualizerCtx.lineWidth = 3;
            visualizerCtx.lineCap = 'round';
            visualizerCtx.lineJoin = 'round';

            // Dibujar múltiples ondas con diferentes colores para efecto de profundidad
            const waveCount = 3;

            for (let wave = 0; wave < waveCount; wave++) {
                visualizerCtx.beginPath();

                const sliceWidth = width / analyser.frequencyBinCount;
                let x = 0;

                // Calcular offset y escala para cada onda
                const waveOffset = wave * 10;
                const waveScale = 1 - (wave * 0.2);
                const opacity = 1 - (wave * 0.3);

                for (let i = 0; i < analyser.frequencyBinCount; i++) {
                    const amplitude = frequencyData[i] / 255.0;
                    const y = centerY + (Math.sin((i / analyser.frequencyBinCount) * Math.PI * 4 + waveOffset) * amplitude * height * 0.4 * waveScale);

                    if (i === 0) {
                        visualizerCtx.moveTo(x, y);
                    } else {
                        visualizerCtx.lineTo(x, y);
                    }

                    x += sliceWidth;
                }

                // Color con gradiente
                const hue = (wave * 60 + Date.now() * 0.05) % 360;
                visualizerCtx.strokeStyle = `hsla(${hue}, 100%, 60%, ${opacity})`;
                visualizerCtx.stroke();
            }

            // Onda principal más prominente
            visualizerCtx.beginPath();
            const sliceWidth = width / analyser.frequencyBinCount;
            let x = 0;

            for (let i = 0; i < analyser.frequencyBinCount; i++) {
                const amplitude = frequencyData[i] / 255.0;
                const smoothAmplitude = amplitude * 0.8 + (frequencyData[Math.max(0, i - 1)] / 255.0) * 0.2;
                const y = centerY + Math.sin((i / analyser.frequencyBinCount) * Math.PI * 2) * smoothAmplitude * height * 0.45;

                if (i === 0) {
                    visualizerCtx.moveTo(x, y);
                } else {
                    visualizerCtx.lineTo(x, y);
                }

                x += sliceWidth;
            }

            // Gradiente para la onda principal
            const gradient = visualizerCtx.createLinearGradient(0, 0, width, 0);
            gradient.addColorStop(0, 'rgba(255, 100, 150, 0.8)');
            gradient.addColorStop(0.5, 'rgba(100, 200, 255, 0.8)');
            gradient.addColorStop(1, 'rgba(150, 255, 100, 0.8)');

            visualizerCtx.strokeStyle = gradient;
            visualizerCtx.lineWidth = 4;
            visualizerCtx.stroke();
        }

        init();
    });
    </script>
</body>
</html>

